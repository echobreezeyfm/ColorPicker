<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoBreeze Color Picker - 演示页面</title>
    
    <link rel="stylesheet" href="ebecp-color-picker.css">
    
    <!-- 核心修正：为 script 标签添加 defer 属性 -->
    <script src="ebecp-color-picker.js" defer></script>
    
    <style>
        :root { --swatch-size: 80px; --panel-bg-color: #f0f2f5; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--panel-bg-color); padding: 2rem; }
        .main-content { max-width: 900px; margin: auto; text-align: center; }
        #swatch-container { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-top: 2rem; }
        .color-swatch { width: var(--swatch-size); height: var(--swatch-size); border-radius: 12px; cursor: pointer; border: 2px solid rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: flex-end; padding: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .swatch-label { font-size: 13px; font-weight: 600; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        #add-swatch-btn { width: var(--swatch-size); height: var(--swatch-size); border-radius: 12px; border: 2px dashed #aaa; background: #fff; color: #aaa; font-size: 3rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .language-switcher { margin-top: 2rem; display: inline-flex; gap: 10px; }
        .language-switcher button { padding: 8px 16px; font-size: 14px; cursor: pointer; border: 1px solid #ccc; background-color: #fff; color: #333; border-radius: 6px; min-width: 100px; display: inline-flex; align-items: center; justify-content: center; }
        .language-switcher button.active { background-color: #007bff; color: white; border-color: #007bff; }
    </style>
</head>
<body>
    
    <main class="main-content">
        <h1 id="main-title">EchoBreeze Color Picker 模块</h1>
        <p id="main-subtitle">
            点击颜色块进行编辑，或添加新颜色。尝试切换下方语言查看模块内部的i18n效果。<br>
            Click a swatch to edit, or click "+" to add a new one. Try switching languages below to see the i18n effect inside the module.
        </p>
        
        <div class="language-switcher">
            <button id="lang-zh" class="active">中文</button>
            <button id="lang-en">English</button>
        </div>

        <div id="swatch-container">
            <button id="add-swatch-btn" title="添加新颜色">+</button>
        </div>
    </main>

    <!-- 模块的HTML结构将由JS加载 -->
    <div id="ebecp-module-wrapper">
        <!-- The content of ebecp-color-picker.html will be loaded here by the main page script -->
    </div>
    
    <!-- 演示页面的交互逻辑 -->
    <script>
        // We wait for the DOM to be fully loaded before running any scripts
        document.addEventListener('DOMContentLoaded', () => {
            const swatchContainer = document.getElementById('swatch-container');
            const addBtn = document.getElementById('add-swatch-btn');
            const initialColors = ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f'];
            let currentLang = 'zh';

            // --- Color Conversion Functions (needed for the demo page) ---
            function hslToRgb(h,s,l){let r,g,b;if(s===0)r=g=b=l*255;else{const hue2rgb=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p};const q=l<0.5?l*(1+s):l+s-l*s;const p=2*l-q;r=hue2rgb(p,q,h+1/3)*255;g=hue2rgb(p,q,h)*255;b=hue2rgb(p,q,h-1/3)*255}return[Math.round(r),Math.round(g),Math.round(b)]}
            function rgbToHex(r,g,b,a){const toHex=c=>('0'+Math.round(c).toString(16)).slice(-2);let hex=`#${toHex(r)}${toHex(g)}${toHex(b)}`;if(a!==1&&a!==undefined)hex+=toHex(a*255);return hex.toUpperCase()}
            
            function updateSwatchUI(element, colorHex) {
                element.style.backgroundColor = colorHex;
                element.querySelector('.swatch-label').textContent = colorHex.toUpperCase();
            }

            function createSwatch(colorHex) {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.dataset.originalColor = colorHex;
                swatch.dataset.currentColor = colorHex;
                swatch.innerHTML = `<span class="swatch-label"></span>`;
                updateSwatchUI(swatch, colorHex);
                
                swatch.addEventListener('click', () => {
                    // Check if module is loaded
                    if (window.ColorPickerModule) {
                        ColorPickerModule.open({
                            originalColor: swatch.dataset.originalColor,
                            currentColor: swatch.dataset.currentColor,
                            lang: currentLang,
                            onConfirm: (finalState) => { 
                                const [r,g,b] = hslToRgb(finalState.h, finalState.s, finalState.l);
                                const newHex = rgbToHex(r,g,b,finalState.a);
                                swatch.dataset.currentColor = newHex;
                                updateSwatchUI(swatch, newHex);
                            }
                        });
                    } else {
                        alert('Color Picker Module is not loaded correctly.');
                    }
                });
                return swatch;
            }

            // --- Load Module HTML ---
            fetch('ebecp-color-picker.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('ebecp-module-wrapper').innerHTML = html;
                    
                    // Now create the swatches, ensuring the module HTML is in place
                    initialColors.forEach(color => swatchContainer.insertBefore(createSwatch(color), addBtn));
                    addBtn.addEventListener('click', () => {
                        const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                        swatchContainer.insertBefore(createSwatch(randomColor), addBtn);
                    });
                });

            // --- i18n Switcher Logic ---
            const langZhBtn = document.getElementById('lang-zh');
            const langEnBtn = document.getElementById('lang-en');
            langZhBtn.addEventListener('click', () => {
                currentLang = 'zh';
                if (window.ColorPickerModule) ColorPickerModule.setLocale('zh');
                langZhBtn.classList.add('active');
                langEnBtn.classList.remove('active');
            });
            langEnBtn.addEventListener('click', () => {
                currentLang = 'en';
                if (window.ColorPickerModule) ColorPickerModule.setLocale('en');
                langEnBtn.classList.add('active');
                langZhBtn.classList.remove('active');
            });
        });
    </script>
</body>
</html>
